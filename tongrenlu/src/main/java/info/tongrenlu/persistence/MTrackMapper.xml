<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="info.tongrenlu.persistence.MTrackMapper">

    <cache flushInterval="3600"/>
    
    <insert id="insertTrack" flushCache="true">
        INSERT INTO M_TRACK(
            SONG_TITLE
        <if test="leadArtist != null">
        ,   LEAD_ARTIST
        </if>
        <if test="trackNumber != null">
        ,   TRACK_NUMBER
        </if>
        ,   FILE_ID
        ,   ADD_DATE
        ,   UPD_DATE
        ,   DEL_FLG
        ) VALUES (
            #{songTitle}
        <if test="leadArtist != null">
        ,   #{leadArtist}
        </if>
        <if test="trackNumber != null">
        ,   #{trackNumber}
        </if>
        ,   #{fileBean.fileId}
        ,   SYSDATE
        ,   SYSDATE
        ,   '0'
        )
    </insert>
    
    <select id="getTrackCount" resultType="int">
        SELECT
            COUNT(F.FILE_ID)
        FROM
            M_FILE F
        ,   M_TRACK T
        ,   M_ARTICLE A
        WHERE
            F.FILE_ID = T.FILE_ID(+)
        AND F.ARTICLE_ID = A.ARTICLE_ID(+)
        <if test="articleId != null">
        AND F.ARTICLE_ID = #{articleId}
        </if>
        <if test="searchQuery != null">
        AND (LOWER(A.TITLE) like '%' || LOWER(#{searchQuery}) || '%'
        OR LOWER(T.SONG_TITLE) like '%' || LOWER(#{searchQuery}) || '%'
        OR LOWER(T.LEAD_ARTIST) like '%' || LOWER(#{searchQuery}) || '%'
        OR LOWER(T.ORIGINAL_TITLE) like '%' || LOWER(#{searchQuery}) || '%')
        </if>
        AND T.DEL_FLG = '0'
        AND F.DEL_FLG = '0'
        AND A.DEL_FLG = '0'
    </select>
    
    <select id="getTrackList" resultType="TrackBean">
        SELECT
            A.SONG_TITLE                as songTitle
        ,   A.LEAD_ARTIST               as leadArtist
        ,   A.ORIGINAL_TITLE            as originalTitle
        ,   A.TRACK_NUMBER              as trackNumber
        ,   A.TITLE                     as album
        ,   A.ARTICLE_ID                as "fileBean.articleId"
        ,   A.FILE_ID                   as "fileBean.fileId"
        ,   A.NAME                      as "fileBean.name"
        ,   A.RNUM                      as "fileBean.orderNo"
        FROM
            (SELECT
                T.SONG_TITLE
            ,   T.LEAD_ARTIST
            ,   T.ORIGINAL_TITLE
            ,   T.TRACK_NUMBER
            ,   F.ARTICLE_ID
            ,   F.FILE_ID
            ,   F.NAME
            ,   A.TITLE
            ,   ROW_NUMBER() OVER (ORDER BY A.ARTICLE_ID, T.TRACK_NUMBER, F.NAME) as RNUM
            FROM
                M_FILE F
            ,   M_TRACK T
            ,   M_ARTICLE A
            WHERE
                F.FILE_ID = T.FILE_ID(+)
            AND F.ARTICLE_ID = A.ARTICLE_ID(+)
            <if test="articleId != null">
            AND F.ARTICLE_ID = #{articleId}
            </if>
            <if test="searchQuery != null">
            AND (LOWER(A.TITLE) like '%' || LOWER(#{searchQuery}) || '%'
            OR LOWER(T.SONG_TITLE) like '%' || LOWER(#{searchQuery}) || '%'
            OR LOWER(T.LEAD_ARTIST) like '%' || LOWER(#{searchQuery}) || '%'
            OR LOWER(T.ORIGINAL_TITLE) like '%' || LOWER(#{searchQuery}) || '%')
            </if>
            AND T.DEL_FLG = '0'
            AND F.DEL_FLG = '0'
            AND A.DEL_FLG = '0'
        ) A
        <if test="start != null and end != null">
            WHERE
                RNUM BETWEEN #{start} AND #{end}
        </if>
        ORDER BY RNUM
    </select>
    
    <update id="deleteTrack" flushCache="true">
        UPDATE M_TRACK A
        SET
            A.DEL_FLG = '1'
        ,   A.UPD_DATE = SYSDATE
        WHERE
            A.FILE_ID = #{fileId}
    </update>
    
    <update id="updateTrackBean" flushCache="true">
        UPDATE M_TRACK A
        SET
            A.UPD_DATE = SYSDATE
        ,   A.TRACK_NUMBER = #{trackNumber}
        <if test="songTitle != null">
        ,   A.SONG_TITLE = #{songTitle}
        </if>
        <if test="leadArtist != null">
        ,   A.LEAD_ARTIST = #{leadArtist}
        </if>
        <if test="leadArtist == null">
        ,   A.LEAD_ARTIST = NULL
        </if>
        <if test="originalTitle != null">
        ,   A.ORIGINAL_TITLE = #{originalTitle}
        </if>
        <if test="originalTitle == null">
        ,   A.ORIGINAL_TITLE = NULL
        </if>
        WHERE
            A.FILE_ID = #{fileBean.fileId}
    </update>
</mapper>